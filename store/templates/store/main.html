{% load static %}
<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Pearl Vibe</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="icon" href="{% static 'images/favicon.ico' %}">
    <link rel="stylesheet" href="{% static 'css/main.css' %}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

    <style>
        /* Mega panel styling */
        .mega-panel { display: none; position: absolute; top: 100%; left: 0; background: #fff; color: #333; width: 520px; box-shadow: 0 6px 18px rgba(0,0,0,0.15); z-index: 2000; padding: 18px; border-radius: 4px; }
        .nav-item.mega-open > .mega-panel { display: block; }
        .mega-panel .col { padding: 0 12px; }
        .mega-panel a { color: #333; text-decoration: none; display: block; padding: 3px 0; }
        .mega-panel a:hover { text-decoration: underline; }

        /* Search suggestions dropdown */
        .search-suggestions { position: absolute; top: 100%; left: 0; right: 0; z-index: 2050; background: #fff; border: 1px solid rgba(0,0,0,0.1); box-shadow: 0 6px 14px rgba(0,0,0,0.08); max-height: 320px; overflow-y: auto; border-radius: 4px; }
        .search-suggestions .suggestion { padding: 8px 12px; cursor: pointer; }
        .search-suggestions .suggestion:hover { background: rgba(0,0,0,0.03); }

        body { padding-top: 72px; }
        @media (max-width: 991px) { .mega-panel { position: static; width: 100%; margin-top: 8px; } }
    </style>
    <script>
    var user = "{{ request.user|default:'AnonymousUser' }}";
</script>

</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark fixed-top w-100" style="background-color:#0E3167;">
    <div class="container-fluid">
        <a class="navbar-brand" href="{% url 'store:home' %}">
            <img src="{% static 'images/logo.png' %}" height="40" alt="Pearl Vibe">
        </a>

        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navCollapse"
                aria-controls="navCollapse" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navCollapse">
            <form class="d-flex position-relative me-3" role="search" method="get" action="{% url 'store:home' %}"
                  style="min-width:320px; max-width:560px; width:45%;">
                <div class="input-group">
                    <input id="nav-search" name="q" autocomplete="off" type="search" class="form-control"
                           placeholder="Search products, brands and more..." value="{{ request.GET.q|default:'' }}">
                    <button class="btn btn-warning" type="submit"><i class="bi bi-search"></i></button>
                </div>
                <div id="search-suggestions" class="search-suggestions d-none"></div>
            </form>

            <ul class="navbar-nav me-auto">
                {% for cat in categories %}
                <li class="nav-item position-relative" style="margin-right:2px;">
                    <a class="nav-link category-link" href="{% url 'store:subcategory' cat.id %}"
                       data-cat-id="{{ cat.id }}" style="color:#FFFFFF;">{{ cat.name }}</a>
                    <div class="mega-panel">
                        <h6 class="fw-bold mb-2">{{ cat.name }}</h6>

                        {% for sub in cat.subcategories.all %}
                        <a href="{% url 'store:products_by_subcategory' sub.id %}">
                            {{ sub.name }}
                        </a>
                        {% empty %}
                        <a href="{% url 'store:subcategory' cat.id %}">
                            View products
                        </a>
                        {% endfor %}
                    </div>

                </li>
                {% endfor %}
            </ul>

            <ul class="navbar-nav">
                {% if user.is_authenticated %}
                <li class="nav-item"><span class="nav-link">Hi, {{ user.first_name|default:user.username }}</span></li>
                <li class="nav-item"><a class="nav-link" href="{% url 'store:logout' %}">Logout</a></li>
                {% else %}
                <li class="nav-item"><a class="nav-link" href="{% url 'store:login' %}">Login</a></li>
                <li class="nav-item"><a class="nav-link" href="{% url 'store:register' %}">Register</a></li>
                {% endif %}
                <li class="nav-item"><a class="nav-link" href="{% url 'store:cart' %}"><img
                        src="{% static 'images/cart.png' %}" height="30" alt="Pearl Vibe"></a></li>
            </ul>
        </div>
    </div>
</nav>

<div class="container mt-3 mb-5">
    {% for message in messages %}
    <div class="alert alert-{{ message.tags }}">{{ message }}</div>
    {% endfor %}

    <!-- ONLY ONE content block -->
    {% block content %}{% endblock %}
</div>

<footer class="footer py-2 mt-4" style="background-color:#0E3167; color:#FFFFFF;">

    <div class="container">
        <div class="row text-center align-items-center">
            <div class="col-md-2 col-6 mb-1"><a href="{% url 'store:home' %}" class="text-white text-decoration-none"><i
                    class="bi bi-house-fill me-1"></i> Home</a></div>
            <div class="col-md-2 col-6 mb-1"><a href="{% url 'store:about' %}"
                                                class="text-white text-decoration-none"><i
                    class="bi bi-info-circle me-1"></i> About</a></div>
            <div class="col-md-2 col-6 mb-1"><a href="{% url 'store:contact' %}"
                                                class="text-white text-decoration-none"><i
                    class="bi bi-envelope me-1"></i> Contact</a></div>
            <div class="col-md-2 col-6 mb-1"><a href="{% url 'store:feedback' %}"
                                                class="text-white text-decoration-none"><i
                    class="bi bi-chat-dots me-1"></i> Feedback</a></div>
            <div class="col-md-4 col-12 mt-1"><small>copyright &copy; {{ now|date:"Y" }} Pearl Vibe</small></div>
        </div>
    </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // Close mega panels when clicking outside
    document.addEventListener('click', function (e) {
      if (!e.target.closest('.nav-item')) {
        document.querySelectorAll('.nav-item.mega-open')
          .forEach(n => n.classList.remove('mega-open'));
      }
    });

    // Desktop: open mega menu on hover ONLY
document.querySelectorAll('.nav-item').forEach(item => {
  item.addEventListener('mouseenter', () => {
    if (window.innerWidth >= 992) {
      item.classList.add('mega-open');
    }
  });

  item.addEventListener('mouseleave', () => {
    if (window.innerWidth >= 992) {
      item.classList.remove('mega-open');
    }
  });
});


    // Account panel toggle
    const accountToggle = document.getElementById('account-toggle');
    accountToggle && accountToggle.addEventListener('click', function (ev) {
      ev.preventDefault();
      const parent = this.closest('#account-panel-li');
      parent.classList.toggle('mega-open');
    });

    // ðŸ” Search input (NO AJAX yet â€“ safe placeholder)
    const searchInput = document.getElementById('nav-search');
    const suggestionsBox = document.getElementById('search-suggestions');
    let searchTimer = null;

    searchInput && searchInput.addEventListener('input', function () {
      const q = this.value.trim();
      if (searchTimer) clearTimeout(searchTimer);

      if (!q) {
        suggestionsBox.classList.add('d-none');
        suggestionsBox.innerHTML = '';
        return;
      }

      searchTimer = setTimeout(() => {
        // AJAX SEARCH WILL BE ADDED LATER
        suggestionsBox.classList.add('d-none');
      }, 220);
    });

    // Hide suggestions on escape / blur
    document.addEventListener('keydown', e => {
      if (e.key === 'Escape') suggestionsBox.classList.add('d-none');
    });

    searchInput && searchInput.addEventListener(
      'blur',
      () => setTimeout(() => suggestionsBox.classList.add('d-none'), 180)
    );
</script>
<script src="{% static 'js/cart.js' %}"></script>
</body>
</html>
